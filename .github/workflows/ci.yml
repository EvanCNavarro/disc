name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  ci:
    runs-on: ubuntu-latest
    env:
      HUGEICONS_NPM_TOKEN: ${{ secrets.HUGEICONS_NPM_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npm run typecheck

  deploy-worker:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          workingDirectory: workers/cron

  verify-deploy:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: ci
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get expected version
        id: version
        run: |
          VERSION=$(grep -oP 'APP_VERSION = "\K[^"]+' packages/shared/src/version.ts)
          echo "expected=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Expected version: $VERSION"

      - name: Wait for Vercel deployment
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_API_TOKEN }}
          VERCEL_PROJECT_ID: prj_0LKhEdVEXGr9vWhO17i3vKgM9EV7
          VERCEL_TEAM_ID: team_xvDxeZVOzvjzLRJSSzrSSHG1
        run: |
          echo "Waiting for Vercel to deploy commit $GITHUB_SHA..."
          for i in $(seq 1 30); do
            RESPONSE=$(curl -sf \
              -H "Authorization: Bearer $VERCEL_TOKEN" \
              "https://api.vercel.com/v6/deployments?projectId=$VERCEL_PROJECT_ID&teamId=$VERCEL_TEAM_ID&limit=5")
            STATE=$(echo "$RESPONSE" | node -e "
              const d=JSON.parse(require('fs').readFileSync('/dev/stdin','utf8'));
              const dep=d.deployments.find(x=>x.meta?.githubCommitSha==='$GITHUB_SHA');
              console.log(dep ? dep.state : 'NOT_FOUND');
            ")
            echo "Attempt $i/30: state=$STATE"
            if [ "$STATE" = "READY" ]; then
              echo "Vercel deployment is READY"
              break
            elif [ "$STATE" = "ERROR" ]; then
              echo "::error::Vercel deployment FAILED"
              exit 1
            fi
            sleep 20
          done
          if [ "$STATE" != "READY" ]; then
            echo "::error::Vercel deployment did not become ready within 10 minutes"
            exit 1
          fi

      - name: Verify live version
        env:
          EXPECTED_VERSION: ${{ steps.version.outputs.expected }}
        run: |
          echo "Verifying https://disc.400.dev/api/version = $EXPECTED_VERSION"
          for attempt in $(seq 1 10); do
            RESPONSE=$(curl -sf https://disc.400.dev/api/version || echo '{}')
            LIVE_VERSION=$(echo "$RESPONSE" | node -e "
              const d=JSON.parse(require('fs').readFileSync('/dev/stdin','utf8'));
              console.log(d.version || 'unknown');
            ")
            echo "Attempt $attempt/10: live=$LIVE_VERSION expected=$EXPECTED_VERSION"
            if [ "$LIVE_VERSION" = "$EXPECTED_VERSION" ]; then
              echo "Version verified: $LIVE_VERSION"
              exit 0
            fi
            sleep 10
          done
          echo "::error::Version mismatch after 10 attempts. Live=$LIVE_VERSION Expected=$EXPECTED_VERSION"
          exit 1
